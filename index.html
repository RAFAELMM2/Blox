<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="UTF-8">
<title>Blox Bux</title>
<link rel="stylesheet" href="style.css">
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { getDatabase, ref, set, onValue, remove } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-database.js";

// Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyC3wm5X7fBXjC8hUQv4sRdHS-v74KWIBC4",
  authDomain: "blox-bux.firebaseapp.com",
  projectId: "blox-bux",
  storageBucket: "blox-bux.appspot.com",
  messagingSenderId: "2964601609",
  appId: "1:2964601609:web:67ee85c8174825aee471d8"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getDatabase(app);

// Verifica login
onAuthStateChanged(auth, user => {
  if (!user) { window.location.href = "login.html"; return; }
  window.currentUserEmail = user.email;
  document.getElementById("user-name").innerText = user.displayName || user.email;
  document.getElementById("user-email").innerText = user.email;

  if(user.email === "marymartins5821@gmail.com"){
    document.getElementById("admin-btn").style.display = "block";
    document.getElementById("botao-comandos").style.display = "block";
  }

  carregarProdutos();
});

// Logout
document.getElementById("logout").addEventListener("click", () => {
  signOut(auth).then(() => window.location.href = "login.html");
});

// Abas
function showTab(tab){
  document.querySelectorAll(".tab-content").forEach(c=>c.classList.remove("show"));
  document.getElementById(tab).classList.add("show");
  document.querySelectorAll(".tab-btn").forEach(btn=>btn.classList.remove("active"));
  document.getElementById("tab-"+tab).classList.add("active");
}
document.getElementById("tab-account").addEventListener("click", ()=>showTab("account"));
document.getElementById("tab-products").addEventListener("click", ()=>showTab("products"));

// Painel Admin
document.getElementById("admin-btn").addEventListener("click", ()=>{
  document.getElementById("admin-section").classList.toggle("show-admin");
});

// Carregar produtos
function carregarProdutos(){
  const lista = document.getElementById("products-list");
  const userEmail = window.currentUserEmail||"";
  onValue(ref(db,'produtos/'), snapshot => {
    const data = snapshot.val() || {};
    lista.innerHTML = "";
    Object.keys(data).forEach(key=>{
      const produto = data[key];
      let removerBtn = "";
      if(userEmail === "marymartins5821@gmail.com"){
        removerBtn = `<button class="remove-btn" data-key="${key}">Remover</button>`;
      }
      lista.innerHTML += `
        <div class="product-card">
          <div class="product-info">
            <h3>${produto.nome}</h3>
            <p>R$ ${produto.preco}</p>
          </div>
          <div class="product-buttons">
            <a href="compra.html?produto=${encodeURIComponent(produto.nome)}">
              <button class="buy-btn">Comprar</button>
            </a>
            ${removerBtn}
          </div>
        </div>
      `;
    });
    document.querySelectorAll(".remove-btn").forEach(btn=>{
      btn.addEventListener("click", e=>{
        const key = e.target.getAttribute("data-key");
        remove(ref(db,'produtos/'+key));
      });
    });
  });
}

// Adicionar produto (Admin)
document.getElementById("product-form").addEventListener("submit", e=>{
  e.preventDefault();
  const nome = document.getElementById("product-name").value;
  const preco = document.getElementById("product-price").value;
  if(!nome || !preco){ alert("Preencha todos os campos!"); return; }
  const newKey = Date.now();
  set(ref(db,'produtos/'+newKey),{nome,preco})
    .then(()=>{ document.getElementById("product-form").reset(); })
    .catch(err=>alert(err.message));
});

// ======================
// PAINEL DE COMANDOS IA
// ======================

// Botão para abrir painel de comandos
document.getElementById("botao-comandos").addEventListener("click", () => {
  const painel = document.getElementById("painel-comandos");
  painel.style.display = painel.style.display === "none" ? "block" : "none";
});

// Lista de ações e palavras-chave (mini IA)
const acoes = {
  bloqueio: ["bloqueie","fecha","trava","fechar","desativar"],
  desbloqueio: ["desbloqueie","abre","libera","ativar","ligar"],
  apagarProdutos: ["apague produtos","delete produtos","remova","limpar estoque"],
  mostrarPedidos: ["mostre pedidos","ver pedidos","listar pedidos","pedidos"]
};

// Chat IA
document.getElementById("chat-form").addEventListener("submit", e => {
  e.preventDefault();
  const input = document.getElementById("chat-input");
  const msg = input.value.toLowerCase().trim();
  const chatLog = document.getElementById("chat-log");

  let acaoDetectada = null;

  for (const [acao, palavras] of Object.entries(acoes)) {
    for (const palavra of palavras) {
      if (msg.includes(palavra)) {
        acaoDetectada = acao;
        break;
      }
    }
    if (acaoDetectada) break;
  }

  let resposta = "❌ Não entendi. Tente algo como 'bloqueie o site' ou 'desbloqueie o site'.";

  if (acaoDetectada === "bloqueio") {
    set(ref(db, "siteStatus"), "offline");
    resposta = "🔒 Site bloqueado.";
  } else if (acaoDetectada === "desbloqueio") {
    set(ref(db, "siteStatus"), "online");
    resposta = "🔓 Site desbloqueado.";
  } else if (acaoDetectada === "apagarProdutos") {
    onValue(ref(db, "produtos"), snapshot => {
      const data = snapshot.val() || {};
      Object.keys(data).forEach(key => remove(ref(db,"produtos/"+key)));
    });
    resposta = "🗑️ Todos os produtos foram apagados.";
  } else if (acaoDetectada === "mostrarPedidos") {
    resposta = "📦 Pedidos atuais: 3 (exemplo).";
  }

  chatLog.innerHTML += `<p><strong>Você:</strong> ${msg}</p>`;
  chatLog.innerHTML += `<p><strong>Sistema:</strong> ${resposta}</p>`;
  chatLog.scrollTop = chatLog.scrollHeight;

  input.value = "";
});

// Bloquear site para todos exceto Mary
onValue(ref(db, "siteStatus"), snapshot => {
  const status = snapshot.val() || "online";
  if(status === "offline" && window.currentUserEmail !== "marymartins5821@gmail.com"){
    document.body.innerHTML = "<h1 style='color:red;text-align:center;margin-top:50px;'>🚫 Loja temporariamente fora do ar</h1>";
  }
});
</script>
</head>
<body class="main-body">

<header>
  <h1>Blox Bux</h1>
  <button id="logout">Sair</button>
</header>

<div class="tabs">
  <button id="tab-account" class="tab-btn active">Minha Conta</button>
  <button id="tab-products" class="tab-btn">Produtos</button>
  <button id="admin-btn" style="display:none;">Admin</button>
  <button id="botao-comandos" style="display:none;">Painel de Comandos</button>
</div>

<!-- Abas -->
<div id="account" class="tab-content show">
  <h2>Minha Conta</h2>
  <p>Nome: <span id="user-name"></span></p>
  <p>Email: <span id="user-email"></span></p>
</div>

<div id="products" class="tab-content">
  <h2>Produtos</h2>
  <div id="products-list" class="product-list"></div>
</div>

<!-- Painel Admin -->
<div id="admin-section" class="admin-panel">
  <h2>Painel Admin</h2>
  <form id="product-form">
    <input id="product-name" placeholder="Nome do Produto" required><br><br>
    <input id="product-price" type="number" placeholder="Preço" required><br><br>
    <button type="submit">Adicionar Produto</button>
  </form>
</div>

<!-- Painel de Comandos -->
<div id="painel-comandos" class="admin-panel" style="display:none;">
  <h2>Painel de Comandos (Apenas Mary)</h2>
  <div id="chat-log" class="chat-log"></div>
  <form id="chat-form">
    <input id="chat-input" placeholder="Digite um comando, ex: bloqueie o site" autocomplete="off">
    <button type="submit">Enviar</button>
  </form>
</div>

</body>
</html>
